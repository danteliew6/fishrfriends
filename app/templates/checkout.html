{% extends "base.html" %}
{% block title %} Paypal Checkout {% endblock %}
{%block content%} 

<!-- This script tag is the payment id of the merchant in out case the FISHRFRIENDS Enterprise -->
<script src="https://www.paypal.com/sdk/js?client-id=AeKkXHKQFzgRzsn8DD3p0MXMZbQN86DaBS9YUDCv5pvbP8r7j6tSiYpyIo6u9yzkm6qe0dN0yWvxWC20"> // Replace YOUR_CLIENT_ID with your sandbox client ID
</script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<div style="margin:30px">
<h1>The total price is ${{data['price']}}</h1>
  <h3>The breakdown is as shown below:</h3>
</div>
<p hidden id = 'hidden-dollars'>{{data['price']}}</p>
<table class="table table-bordered">
  <thead>
    <tr>
      <th scope="col">Fish ID</th>
      <th scope="col">Quantity</th>
      <th scope="col">Price</th>
    </tr>
  </thead>
  <tbody>
    {% for fishes in data['orders'] %}
    {% if fishes.quantity != '0' %}
    <tr>
      <td>{{fishes.fish_id}}</td>
      <td>{{fishes.quantity}}</td>
      <td>${{fishes.price}}</td>
    </tr>
    {% endif %}
    {% endfor %}

  </tbody>
</table>
<div style = "margin:30px">
  <label for="collection_datetime">Choose a time for your collection:</label>

  <input type="datetime-local" id="collection_datetime"
         name="collection_datetime" value="2021-04-02T19:30">
</div>

<div id="paypal-button-container">
<style>
    .cardshadow {
    /* Add shadows to create the "card" effect */
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
    transition: 0.3s;
    }

    /* On mouse-over, add a deeper shadow */
    .cardshadow:hover {
    box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
    }

    

</style>

<div class="d-flex justify-content-center p-2 mt-5">
    <div class="card cardshadow text-center m-5" style="min-width: 400px;">
        <div class="card-body mt-5">
          <h2>Total cost: ${{data['price']}}</h2>
        </div>
      <div class="d-flex justify-content-center m-3">
        <div id="paypal-button-container">
        </div>
      </div>
    </div>


</div>




<!-- Add the checkout buttons, set up the order and approve the order -->
<script>
  var total_price = document.getElementById('hidden-dollars').innerHTML;
  var collection_datetime = document.getElementById('collection_datetime');
  var now = new Date();
  currentHours = ("0" + now.getHours()).slice(-2);
  currentMinutes = ("0" + now.getMinutes()).slice(-2);
  currentMonth = ("0" + now.getMonth()).slice(-2);
  currentDay = ("0" + now.getDate()).slice(-2);
  collection_datetime.setAttribute('min', now.getFullYear() + "-" + currentMonth + "-" + currentDay + "T" + currentHours + ":" + currentMinutes);
  collection_datetime.setAttribute('value', now.getFullYear() + "-" + currentMonth + "-" + currentDay + "T" + currentHours + ":" + currentMinutes);
  now.setDate(now.getDate() + 24 * 14);
  currentMonth = ("0" + now.getMonth()).slice(-2);
  currentDay = ("0" + now.getDate()).slice(-2);
  collection_datetime.setAttribute('max', now.getFullYear() + "-" + currentMonth + "-" + currentDay + "T" + currentHours + ":" + currentMinutes);

 // managePayment({{data|safe}});

  paypal.Buttons({
    createOrder: function(data, actions) {
      return actions.order.create({
        purchase_units: [{
          amount: {
            value: total_price
          }
        }]
      });
    },
    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        managePayment({{data|safe}})
        alert('Transaction completed by ' + details.payer.name.given_name);

      });
    }
  }).render('#paypal-button-container'); // Display payment options on your web page

  function managePayment(data) {
    const url = `http://localhost:5005/payment_manage`;
    var dateAndTime = collection_datetime.value.split('T');
    const request = new XMLHttpRequest();
    var payment_manage_json = {
      "amount" : data["price"],
      "order_items" : data["orders"],
      "collection_datetime" : dateAndTime[0] + " " + dateAndTime[1],
      "username" : sessionStorage.getItem("email")
    }
    console.log(payment_manage_json);
    axios.post(url,payment_manage_json)
    .then((response) => {
      if (response.status > 199 && response.status < 300) {
        window.location.replace("/home");
      } else {
        console.log("problem with checkout!")
      }
    })
   
  }
</script>

{% endblock %}
